{% extends "base.html" %}

{% block content %}
    <div class="dashboard-header">
        <h1>Collection Pok√©mon</h1>
        <div class="view-toggle">
            <button class="active" data-view="collection">Collection</button>
            <button data-view="wanted">Recherch√©es</button>
        </div>
    </div>

    {% if session.get('show_trade_notification') %}
    <div class="trade-notification" id="trade-notification">
        <div class="notification-content">
            <div class="notification-icon">üîÑ</div>
            <div class="notification-text">
                <h3>√âchanges possibles!</h3>
                <p>Il y a {{ session.get('trade_matches_count', 0) }} carte(s) recherch√©e(s) disponible(s) chez d'autres collectionneurs.</p>
            </div>
            <button class="close-notification" id="hide-notification">Masquer</button>
        </div>
    </div>
    {% endif %}

    <div class="all-sets-container collection-view">
        {% for set in all_sets_with_cards %}
            <div class="set-container">
                <div class="set-header">
                    <h2>{{ set.set_id }} - {{ set.name }}</h2>
                    <div class="set-stats">
                        {% set owned_count = 0 %}
                        {% for card in set.cards %}
                            {% set card_key = card.set_id ~ '-' ~ card.card_number %}
                            {% if card_key in extra_dict %}
                                {% set owned_count = owned_count + 1 %}
                            {% endif %}
                        {% endfor %}
                        <span class="card-count">{{ owned_count }} / {{ set.cards|length }}</span>
                    </div>
                </div>
                
                <div class="cards-grid">
                    {% for card in set.cards %}
                        {% set card_key = card.set_id ~ '-' ~ card.card_number %}
                        {% set is_owned = card_key in extra_dict %}
                        {% set is_wanted = card_key in wanted_dict %}
                        {% set is_available = card_key in available_dict %}
                        
                        <div class="card-box {% if is_owned %}owned{% elif is_wanted %}wanted{% if is_available %} available{% endif %}{% else %}missing{% endif %}" 
                             data-card-id="{{ card.id }}" 
                             data-set-id="{{ card.set_id }}" 
                             data-card-number="{{ card.card_number }}"
                             {% if is_available %}data-owners="{{ available_dict[card_key] }}"{% endif %}>
                            <div class="card-image-container">
                                {% if is_owned and card.image_url %}
                                    <img src="{{ card.image_url }}" alt="{{ card.french_name or card.card_name }}">
                                {% else %}
                                    <div class="placeholder-number">{{ card.card_number }}</div>
                                {% endif %}
                            </div>
                            <div class="card-number">N¬∞{{ card.card_number }}</div>
                            
                            {% if is_owned and extra_dict[card_key] > 1 %}
                                <div class="card-quantity">√ó{{ extra_dict[card_key] }}</div>
                            {% endif %}
                            
                            {% if is_wanted %}
                                <div class="card-wanted-badge">
                                    <i class="fas fa-search"></i>
                                </div>
                                
                                {% if is_available %}
                                    <div class="available-badge">Disponible</div>
                                {% endif %}
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="floating-action-button">
        <a href="{{ url_for('add_card') }}" class="fab-button">+</a>
    </div>



    <div class="modal" id="card-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div class="card-details">
                <div class="card-image-large">
                    <img id="modal-card-image" src="" alt="Carte Pok√©mon">
                </div>
                <div class="card-info">
                    <h3 id="modal-card-name"></h3>
                    <p id="modal-card-original-name" class="card-original-name"></p>
                    <p>Num√©ro: <span id="modal-card-number"></span></p>
                    <p>S√©rie: <span id="modal-card-set"></span></p>
                    <div id="modal-card-quantity-container">
                        <p>Quantit√©: <span id="modal-card-quantity"></span></p>
                    </div>
                    <div class="card-actions" id="card-actions-container">
                        <div id="not-in-collection-actions">
                            <button id="add-to-collection" class="button">Ajouter √† ma collection</button>
                            <button id="add-to-wanted" class="button secondary-button">Ajouter aux recherches</button>
                        </div>
                        <div id="in-collection-actions" style="display:none;">
                            <button id="increment-quantity" class="button">+1 Quantit√©</button>
                            <button id="remove-card" class="button danger-button">Supprimer</button>
                        </div>
                        <div id="wanted-card-actions" style="display:none;">
                            <button id="convert-to-collection" class="button success-button">Obtenue! Ajouter √† ma collection</button>
                            <button id="remove-from-wanted" class="button danger-button">Retirer des recherches</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    

    <div class="all-wanted-cards wanted-view" style="display: none;">
        {% if has_wanted_cards %}
            {% for set in all_sets_with_cards %}
                <div class="set-container">
                    <div class="set-header">
                        <h2>{{ set.set_id }} - {{ set.name }}</h2>
                    </div>
                    <div class="cards-grid">
                        {% for card in set.cards %}
                            {% set card_key = card.set_id ~ '-' ~ card.card_number %}
                            
                            {% set is_wanted = card_key in wanted_dict %}
                            {% set is_available = card_key in available_dict %}
                            
                            {% if not is_owned and is_wanted %}
                                <div class="card-box {% if is_wanted %}wanted{% endif %}"
                                    data-card-id="{{ card.id }}"
                                    data-set-id="{{ card.set_id }}"
                                    data-card-number="{{ card.card_number }}"
                                    {% if is_available %}data-owners="{{ available_dict[card_key] }}"{% endif %}>
                                    <div class="card-image-container" >
                                        <img src="{{ card.image_url }}" alt="{{ card.french_name or card.card_name }}">
                                    </div>
                                    <div class="card-number">N¬∞{{ card.card_number }}</div>
                                    
                                    {% if is_wanted %}
                                        <div class="card-wanted-badge">
                                            <i class="fas fa-search"></i>
                                        </div>
                                        
                                        {% if is_available %}
                                            <div class="available-badge">Disponible</div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="no-cards-message">
                <div class="message-icon">üîç</div>
                <h3>Vous n'avez pas encore choisi de cartes √† rechercher!</h3>
                <p>Ajoutez des cartes que vous souhaitez obtenir pour les voir appara√Ætre ici.</p>
                <a href="{{ url_for('add_card') }}" class="button">Ajouter des cartes √† rechercher</a>
            </div>
        {% endif %}
    </div>
    <div class="account-actions">
        <h3>Actions du compte</h3>
        <div class="action-buttons">
            <a href="{{ url_for('logout') }}" class="button secondary-button">Se d√©connecter</a>
            <a href="#" id="delete-account-btn" class="button danger-button">Supprimer mon compte</a>
        </div>
    </div>
    <div class="modal" id="delete-account-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3>Supprimer votre compte?</h3>
            <p>Cette action est irr√©versible. Toutes vos cartes et pr√©f√©rences seront supprim√©es.</p>
            <div class="modal-actions">
                <button id="confirm-delete" class="button danger-button">Confirmer la suppression</button>
                <button id="cancel-delete" class="button secondary-button">Annuler</button>
            </div>
        </div>
    </div>
    <style>
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .view-toggle {
            display: flex;
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }
        
        .set-selector {
            margin-bottom: 20px;
        }
        
        .set-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .set-button {
            background: #f1f5f9;
            color: var(--dark-color);
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-block;
        }
        
        .set-button.active {
            background: var(--primary-color);
            color: white;
        }
        
        .set-info {
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            padding: 15px 20px;
            margin-bottom: 20px;
        }
        
        .set-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding-bottom: 10px;
        }
        
        .set-header h2 {
            display: flex;
            align-items: center;
        }
        
        .set-header h2::before {
            content: "‚ñº";
            font-size: 0.8rem;
            margin-right: 10px;
            transition: transform 0.3s ease;
        }
        
        .set-container.collapsed .set-header h2::before {
            transform: rotate(-90deg);
        }
        
        .set-container.collapsed .cards-grid {
            display: none;
        }
        
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .card-box {
            position: relative;
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
            aspect-ratio: 2.5/3.5;
            display: flex;
            flex-direction: column;
        }
        
        .card-box.owned {
            border: 2px solid #48bb78;
        }
        
        .card-box.wanted {
            border: 2px solid #3182ce;
        }
        
        .card-box.available {
            border: 2px solid var(--accent-color);
            background: linear-gradient(to bottom, rgba(255, 209, 102, 0.05), rgba(255, 209, 102, 0.15));
        }
        
        .card-box.missing {
            background: #f1f5f9;
            color: #64748b;
        }
        
        .card-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 25px -5px rgba(0,0,0,0.1);
        }
        
        .card-image-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .card-image-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .placeholder-number {
            font-size: 2rem;
            font-weight: 700;
            color: #cbd5e0;
        }
        
        .card-number {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 8px;
            font-size: 0.8rem;
            text-align: center;
        }
        
        .card-quantity {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #1a202c;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        
        
        .empty-collection {
            grid-column: 1 / -1;
            text-align: center;
            padding: 50px 0;
        }
        
        .floating-action-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 100;
        }
        
        .fab-button {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 60px;
            height: 60px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            font-size: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            text-decoration: none;
            transition: transform 0.2s ease, background 0.2s ease;
        }
        
        .fab-button:hover {
            transform: scale(1.1);
            background: #4958b5;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            width: 80%;
            max-width: 900px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            position: relative;
            padding: 30px;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #aaa;
        }
        
        .close-modal:hover {
            color: var(--dark-color);
        }
        
        .card-details {
            display: flex;
            gap: 30px;
        }
        
        .card-image-large {
            flex: 0 0 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .card-image-large img {
            max-width: 100%;
            max-height: 500px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card-info {
            flex: 1;
        }
        
        .card-info h3 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .card-actions {
            margin-top: 30px;
            display: flex;
            gap: 15px;
        }
        
        .no-image {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f0f2f5;
            color: #718096;
            font-size: 0.8rem;
            text-align: center;
        }
        
        @media (max-width: 992px) {
            .cards-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .card-details {
                flex-direction: column;
            }
            
            .card-image-large {
                margin-bottom: 20px;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }
        
        @media (max-width: 576px) {
            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .trade-notification {
            background: linear-gradient(to right, var(--primary-color), #6c80e0);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 25px;
            color: white;
            box-shadow: var(--card-shadow);
            animation: fadeIn 0.5s ease;
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .notification-icon {
            font-size: 2rem;
            background: rgba(255, 255, 255, 0.2);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .notification-text {
            flex: 1;
        }
        
        .notification-text h3 {
            color: white;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .notification-text p {
            margin: 0;
            opacity: 0.9;
        }
        
        .close-notification {
            background: rgba(0, 0, 0, 0.1);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .close-notification:hover {
            background: rgba(0, 0, 0, 0.2);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Style pour les cartes recherch√©es disponibles */
        .card-box.wanted.available {
            border-color: var(--accent-color);
            background: linear-gradient(to bottom, rgba(255, 209, 102, 0.05), rgba(255, 209, 102, 0.15));
        }
        
        .card-box.wanted.available::after {
            content: '‚úì';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
        }
        
        .available-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent-color);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 5;
        }

        /* Style pour la vue des cartes recherch√©es */
        .all-wanted-cards {
            margin-top: 25px;
        }
        
        .set-container {
            margin-bottom: 30px;
        }
        
        .no-cards-message {
            text-align: center;
            background: white;
            border-radius: 12px;
            padding: 40px 20px;
            margin: 30px 0;
            box-shadow: var(--card-shadow);
        }
        
        .message-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .no-cards-message h3 {
            margin-bottom: 10px;
            color: var(--dark-color);
        }
        
        .no-cards-message p {
            color: #64748b;
            margin-bottom: 25px;
        }
        
        .no-cards-message .button {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .no-cards-message .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(93, 111, 211, 0.4);
        }

        /* Styles pour l'affichage des s√©ries */
        .all-sets-container {
            margin-top: 25px;
        }
        
        .set-container {
            margin-bottom: 40px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
        }
        
        .set-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .set-stats {
            background: var(--primary-color);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .success-button {
            background-color: #48bb78;
            color: white;
        }

        .success-button:hover {
            background-color: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(56, 161, 105, 0.3);
        }

        .card-owners {
            margin-top: 15px;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
        }

        .card-owners h4 {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        .owners-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .owners-list li {
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .owners-list li:last-child {
            border-bottom: none;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle entre les vues Collection et Recherch√©es
            const viewButtons = document.querySelectorAll('.view-toggle button');
            const collectionView = document.querySelectorAll('.collection-view');
            const wantedView = document.querySelectorAll('.wanted-view');
            
            viewButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Mettre √† jour les boutons
                    viewButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Basculer les vues
                    const view = this.getAttribute('data-view');
                    if (view === 'collection') {
                        wantedView.forEach(el => el.style.display = 'none');
                        collectionView.forEach(el => el.style.display = '');
                    } else {
                        collectionView.forEach(el => el.style.display = 'none');
                        wantedView.forEach(el => el.style.display = '');
                    }
                });
            });
            
            // Modal pour afficher les d√©tails d'une carte
            const modal = document.getElementById('card-modal');
            const closeModal = document.querySelector('.close-modal');
            const cardBoxes = document.querySelectorAll('.card-box');
            
            cardBoxes.forEach(box => {
                box.addEventListener('click', function() {
                    const cardId = this.getAttribute('data-card-id');
                    const setId = this.getAttribute('data-set-id');
                    const cardNumber = this.getAttribute('data-card-number');
                    const isOwned = this.classList.contains('owned');
                    const isWanted = this.classList.contains('wanted');
                    
                    // Afficher les bonnes actions selon l'√©tat de la carte
                    document.getElementById('not-in-collection-actions').style.display = (!isOwned && !isWanted) ? 'block' : 'none';
                    document.getElementById('in-collection-actions').style.display = isOwned ? 'block' : 'none';
                    document.getElementById('wanted-card-actions').style.display = (!isOwned && isWanted) ? 'block' : 'none';
                    
                    // D√©sactiver le bouton "Ajouter aux recherches" si d√©j√† recherch√©e
                    const addToWantedBtn = document.getElementById('add-to-wanted');
                    if (addToWantedBtn) {
                        addToWantedBtn.disabled = isWanted;
                        if (isWanted) {
                            addToWantedBtn.textContent = 'D√©j√† dans vos recherches';
                        } else {
                            addToWantedBtn.textContent = 'Ajouter aux recherches';
                        }
                    }
                    
                    // R√©cup√©rer les infos de la carte via API
                    fetch(`/card_info?set_id=${setId}&card_number=${cardNumber}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.exists) {
                                document.getElementById('modal-card-image').src = data.image_url || 'path/to/placeholder.png';
                                document.getElementById('modal-card-name').textContent = data.french_name || data.card_name;
                                
                                if (data.french_name && data.french_name !== data.card_name) {
                                    document.getElementById('modal-card-original-name').textContent = `(${data.card_name})`;
                                    document.getElementById('modal-card-original-name').style.display = 'block';
                                } else {
                                    document.getElementById('modal-card-original-name').style.display = 'none';
                                }
                                
                                document.getElementById('modal-card-number').textContent = data.card_number;
                                document.getElementById('modal-card-set').textContent = data.set_id;
                                
                                // Afficher la quantit√© si c'est une carte poss√©d√©e
                                if (isOwned) {
                                    const quantity = this.querySelector('.card-quantity')?.textContent.replace('√ó', '') || '1';
                                    document.getElementById('modal-card-quantity').textContent = quantity;
                                    document.getElementById('modal-card-quantity-container').style.display = 'block';
                                } else {
                                    document.getElementById('modal-card-quantity-container').style.display = 'none';
                                }
                                
                                // Nettoyer tout affichage pr√©c√©dent des propri√©taires
                                const existingOwners = document.querySelector('.card-owners');
                                if (existingOwners) {
                                    existingOwners.remove();
                                }
                                
                                // R√©cup√©rer les propri√©taires et les afficher
                                console.log(`R√©cup√©ration des propri√©taires pour ${data.set_id}-${data.card_number}`);
                                
                                fetch(`/get_card_owners?set_id=${data.set_id}&card_number=${data.card_number}`)
                                    .then(response => response.json())
                                    .then(ownersData => {
                                        console.log("Donn√©es des propri√©taires re√ßues:", ownersData);
                                        
                                        if (ownersData.owners && ownersData.owners.length > 0) {
                                            console.log(`${ownersData.owners.length} propri√©taires trouv√©s`);
                                            
                                            const ownersSection = document.createElement('div');
                                            ownersSection.className = 'card-owners';
                                            
                                            const title = document.createElement('h4');
                                            title.textContent = 'Disponible chez:';
                                            ownersSection.appendChild(title);
                                            
                                            const ownersList = document.createElement('ul');
                                            ownersList.className = 'owners-list';
                                            
                                            ownersData.owners.forEach(owner => {
                                                const ownerItem = document.createElement('li');
                                                ownerItem.textContent = owner;
                                                ownersList.appendChild(ownerItem);
                                            });
                                            
                                            ownersSection.appendChild(ownersList);
                                            document.querySelector('.card-info').appendChild(ownersSection);
                                        } else {
                                            console.log("Aucun propri√©taire trouv√©");
                                        }
                                    })
                                    .catch(error => {
                                        console.error("Erreur lors de la r√©cup√©ration des propri√©taires:", error);
                                    });
                                
                                modal.style.display = 'block';
                            }
                        });
                });
            });
            
            closeModal.addEventListener('click', function() {
                modal.style.display = 'none';
            });
            
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            // Incr√©menter la quantit√©
            document.getElementById('increment-quantity').addEventListener('click', function() {
                const setId = document.getElementById('modal-card-set').textContent;
                const cardNumber = document.getElementById('modal-card-number').textContent;
                
                fetch('/increment_card', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        set_id: setId,
                        card_number: cardNumber
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const quantityElement = document.getElementById('modal-card-quantity');
                        const newQuantity = parseInt(quantityElement.textContent) + 1;
                        quantityElement.textContent = newQuantity;
                        
                        // Mettre √† jour l'affichage dans la grille
                        const cardBox = document.querySelector(`.card-box[data-set-id="${setId}"][data-card-number="${cardNumber}"]`);
                        let quantityBadge = cardBox.querySelector('.card-quantity');
                        
                        if (quantityBadge) {
                            quantityBadge.textContent = `√ó${newQuantity}`;
                        } else {
                            const newBadge = document.createElement('div');
                            newBadge.className = 'card-quantity';
                            newBadge.textContent = `√ó2`;
                            cardBox.appendChild(newBadge);
                        }
                    }
                });
            });
            
            // Supprimer une carte
            document.getElementById('remove-card').addEventListener('click', function() {
                if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette carte?')) {
                    return;
                }
                
                const setId = document.getElementById('modal-card-set').textContent;
                const cardNumber = document.getElementById('modal-card-number').textContent;
                const isWanted = document.querySelector('.wanted-view').style.display !== 'none';
                
                fetch('/remove_card', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        set_id: setId,
                        card_number: cardNumber,
                        is_wanted: isWanted
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        modal.style.display = 'none';
                        const cardBox = document.querySelector(`.card-box[data-set-id="${setId}"][data-card-number="${cardNumber}"]`);
                        cardBox.remove();
                    }
                });
            });

            // Code pour la suppression de compte
            document.getElementById('delete-account-btn').addEventListener('click', function() {
                document.getElementById('delete-account-modal').style.display = 'block';
            });
            
            document.getElementById('cancel-delete').addEventListener('click', function() {
                document.getElementById('delete-account-modal').style.display = 'none';
            });
            
            document.getElementById('confirm-delete').addEventListener('click', function() {
                fetch('/delete_account', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/';
                    } else {
                        alert('Erreur: ' + data.message);
                    }
                });
            });

            // Ajouter ce code pour g√©rer la notification
            const hideNotificationBtn = document.getElementById('hide-notification');
            if (hideNotificationBtn) {
                hideNotificationBtn.addEventListener('click', function() {
                    // Masquer visuellement la notification
                    const notification = document.getElementById('trade-notification');
                    notification.style.display = 'none';
                    
                    // Envoyer une requ√™te pour ne plus afficher la notification
                    fetch('/hide_trade_notification', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) {
                            console.error('Erreur lors de la d√©sactivation de la notification');
                        }
                    });
                });
            }

            // Ajouter ensuite le gestionnaire pour le nouveau bouton
            document.getElementById('convert-to-collection').addEventListener('click', function() {
                const setId = document.getElementById('modal-card-set').textContent;
                const cardNumber = document.getElementById('modal-card-number').textContent;
                
                fetch('/convert_to_collection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        set_id: setId,
                        card_number: cardNumber
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Fermer la modale
                        document.getElementById('card-modal').style.display = 'none';
                        
                        // Rafra√Æchir la page pour montrer les changements
                        window.location.reload();
                    } else {
                        alert('Erreur: ' + data.message);
                    }
                });
            });

            // Ajouter aussi un gestionnaire pour le bouton "Retirer des recherches"
            document.getElementById('remove-from-wanted').addEventListener('click', function() {
                const setId = document.getElementById('modal-card-set').textContent;
                const cardNumber = document.getElementById('modal-card-number').textContent;
                
                fetch('/remove_card', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        set_id: setId,
                        card_number: cardNumber,
                        is_wanted: true
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Fermer la modale
                        document.getElementById('card-modal').style.display = 'none';
                        
                        // Rafra√Æchir la page pour montrer les changements
                        window.location.reload();
                    } else {
                        alert('Erreur: ' + data.message);
                    }
                });
            });
        });

        function updateCardCounts() {
            // Pour chaque conteneur de s√©rie
            document.querySelectorAll('.collection-view .set-container').forEach(container => {
                // Compter toutes les cartes
                const totalCards = container.querySelectorAll('.cards-grid .card-box').length;
                
                // Compter les cartes avec la classe "owned"
                const ownedCards = container.querySelectorAll('.cards-grid .card-box.owned').length;
                
                // Mettre √† jour le compteur
                const countElement = container.querySelector('.set-stats .card-count');
                if (countElement) {
                    countElement.textContent = `${ownedCards} / ${totalCards}`;
                    
                    // Mettre en √©vidence les s√©ries compl√®tes ou avanc√©es
                    if (ownedCards === totalCards && totalCards > 0) {
                        countElement.style.color = '#48bb78'; // vert
                        countElement.style.fontWeight = 'bold';
                    } else if (ownedCards > totalCards * 0.75) {
                        countElement.style.color = '#3182ce'; // bleu
                    }
                }
            });
        }

        // Ex√©cuter la fonction apr√®s le chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Laisser un peu de temps pour que tout se charge
            setTimeout(updateCardCounts, 300);
            
            // Mettre √† jour lors du changement de vue
            document.querySelectorAll('.view-toggle button').forEach(button => {
                button.addEventListener('click', function() {
                    setTimeout(updateCardCounts, 100);
                });
            });
        });

        // Fonction pour rendre les sets r√©tractables
        function setupCollapsibleSets() {
            // Pour chaque ent√™te de set
            document.querySelectorAll('.set-header').forEach(header => {
                header.addEventListener('click', function() {
                    // R√©cup√©rer le conteneur parent
                    const setContainer = this.closest('.set-container');
                    // Basculer la classe collapsed
                    setContainer.classList.toggle('collapsed');
                    
                    // Sauvegarder l'√©tat dans le localStorage
                    const setId = this.querySelector('h2').textContent.split(' - ')[0].trim();
                    localStorage.setItem(`set_${setId}_collapsed`, setContainer.classList.contains('collapsed'));
                });
            });
            
            // Restaurer l'√©tat pr√©c√©dent depuis localStorage
            document.querySelectorAll('.set-container').forEach(container => {
                const setId = container.querySelector('h2').textContent.split(' - ')[0].trim();
                const isCollapsed = localStorage.getItem(`set_${setId}_collapsed`) === 'true';
                
                if (isCollapsed) {
                    container.classList.add('collapsed');
                }
            });
        }

        // Ex√©cuter apr√®s le chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Configurer les sets r√©tractables
            setupCollapsibleSets();
            
            // Autres fonctions existantes...
            setTimeout(updateCardCounts, 300);
            
            // ... reste du code existant ...
        });
    </script>
{% endblock %} 